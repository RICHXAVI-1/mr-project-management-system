{% extends 'client/base.html' %}

{% block title %}Messages - MR PROJECT{% endblock %}

{% block client_title %}Messages{% endblock %}

{% block client_content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0 text-light">Message History</h5>
            </div>
            <div class="card-body">
                <div class="message-container">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="message {% if message.sender_id == current_user.id %}message-sent{% else %}message-received{% endif %}">
                                <div class="message-content">
                                    {% if message.audio_path %}
                                        <audio controls src="{{ url_for('uploaded_file', filename=message.audio_path) }}"></audio>
                                    {% elif message.content and message.content.startswith('[VOICE]:') %}
                                        {% set filename = message.content.split(':',1)[1] %}
                                        <audio controls src="{{ url_for('uploaded_file', filename=filename) }}"></audio>
                                    {% else %}
                                        {{ message.content }}
                                    {% endif %}
                                </div>
                                <div class="message-meta">
                                    {{ message.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% if not message.sender_id == current_user.id and not message.is_read %}
                                        <span class="badge bg-warning text-dark ms-2">New</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <h5>No messages yet</h5>
                            <p class="text-muted">Start a conversation with the support team!</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Send Message Form -->
                <form method="POST" action="{{ url_for('client_messages') }}" class="mt-4" enctype="multipart/form-data" id="messageForm">
                    {{ form.hidden_tag() }}
                    <div class="input-group">
                        {{ form.content(class="form-control", rows=1, placeholder="Type your message here...") }}
                        
                        <!-- Voice note buttons -->
                        <button type="button" class="btn btn-outline-secondary" id="recordBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button type="button" class="btn btn-danger d-none" id="stopBtn">
                            <i class="fas fa-stop"></i>
                        </button>

                        <!-- Send text button -->
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <small id="voiceStatus" class="form-text text-muted"></small>
                    <audio id="lastPlayback" controls style="display:none; margin-top:8px; width:100%;"></audio>
                </form>

                <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const recordBtn = document.getElementById("recordBtn");
                    const stopBtn = document.getElementById("stopBtn");
                    const status = document.getElementById("voiceStatus");
                    const playback = document.getElementById("lastPlayback");

                    let mediaRecorder;
                    let chunks = [];

                    recordBtn.addEventListener("click", async function () {
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            mediaRecorder = new MediaRecorder(stream);
                            chunks = [];

                            mediaRecorder.ondataavailable = e => chunks.push(e.data);

                            mediaRecorder.onstart = () => {
                                recordBtn.classList.add("d-none");
                                stopBtn.classList.remove("d-none");
                                status.textContent = "Recording...";
                            };

                            mediaRecorder.onstop = async () => {
                                stopBtn.classList.add("d-none");
                                recordBtn.classList.remove("d-none");
                                status.textContent = "Uploading...";

                                const blob = new Blob(chunks, { type: "audio/webm" });
                                playback.src = URL.createObjectURL(blob);
                                playback.style.display = "block";

                                const fd = new FormData();
                                fd.append("voice", blob, "voice_note.webm");

                                try {
                                    const res = await fetch("{{ url_for('upload_voice') }}", {
                                        method: "POST",
                                        body: fd
                                    });
                                    const data = await res.json();
                                    if (res.ok) {
                                        status.textContent = "Voice note sent!";
                                        setTimeout(() => location.reload(), 800);
                                    } else {
                                        status.textContent = data.error || "Upload failed.";
                                    }
                                } catch (err) {
                                    console.error("Upload error:", err);
                                    status.textContent = "Error uploading voice note.";
                                }
                            };

                            mediaRecorder.start();
                        } catch (err) {
                            alert("Microphone access denied.");
                            console.error(err);
                        }
                    });

                    stopBtn.addEventListener("click", function () {
                        if (mediaRecorder && mediaRecorder.state === "recording") {
                            mediaRecorder.stop();
                        }
                    });
                });
                </script>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0 text-light">Contact Information</h5>
            </div>
            <div class="card-body">
                <p>If you need immediate assistance, you can also reach us through:</p>
                
                <div class="d-flex align-items-center mb-3">
                    <div class="rounded-circle bg-success p-2 me-3">
                        <i class="fab fa-whatsapp text-white"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">WhatsApp Support</h6>
                        <a href="https://wa.me/2348026612882" target="_blank">+2348026612882</a>
                    </div>
                </div>
                
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-primary p-2 me-3">
                        <i class="fas fa-envelope text-white"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">Email Support</h6>
                        <a href="mailto:mrprojectwriting@gmail.com">mrprojectwriting@gmail.com</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0 text-light">Message Guidelines</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Please allow up to 24 hours for a response</li>
                    <li>Be specific about your questions or concerns</li>
                    <li>Include relevant details about your project</li>
                    <li>For urgent matters, please use WhatsApp</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
