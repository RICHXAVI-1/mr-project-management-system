{% extends 'admin/base.html' %}

{% block title %}Messages - MR PROJECT{% endblock %}

{% block admin_title %}Messages{% endblock %}

{% block admin_actions %}
<button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#composeMessageModal">
    <i class="fas fa-envelope me-1"></i> Compose Message
</button>
{% endblock %}

{% block admin_content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="messagesTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active text-light" id="received-tab" data-bs-toggle="tab" data-bs-target="#received" type="button" role="tab">
                            Received Messages
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link text-light" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent" type="button" role="tab">
                            Sent Messages
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="messagesTabsContent">
                    <!-- Received Messages Tab -->
                    <div class="tab-pane fade show active" id="received" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>From</th>
                                        <th>Message</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for message in received_messages %}
                                    <tr>
                                        <td>{{ message.sender.name }}</td>
                                        <td>
                                            {% if message.audio_path %}
                                                <audio controls src="{{ url_for('uploaded_file', filename=message.audio_path) }}"></audio>
                                            {% elif message.content and message.content.startswith('[VOICE]:') %}
                                                {% set filename = message.content.split(':',1)[1] %}
                                                <audio controls src="{{ url_for('uploaded_file', filename=filename) }}"></audio>
                                            {% else %}
                                                {{ message.content|truncate(50) }}
                                            {% endif %}
                                        </td>
                                        <td>{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if message.is_read %}
                                                <span class="badge bg-success">Read</span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark">New</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center">No received messages</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Quick Reply Section -->
                        <div class="mt-4">
                            <form method="POST" action="{{ url_for('admin_messages') }}" enctype="multipart/form-data" id="quickReplyForm">
                                {{ form.hidden_tag() }}
                                <div class="input-group">
                                    {{ form.content(class="form-control", rows=1, placeholder="Type your reply...") }}

                                    <!-- Voice note button -->
                                    <button type="button" class="btn btn-outline-secondary" id="recordBtn">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger d-none" id="stopBtn">
                                        <i class="fas fa-stop"></i>
                                    </button>

                                    <!-- Send text button -->
                                    <button class="btn btn-primary" type="submit">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                                <small id="voiceStatus" class="form-text text-muted"></small>
                                <audio id="lastPlayback" controls style="display:none; margin-top:8px; width:100%;"></audio>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Sent Messages Tab -->
                    <div class="tab-pane fade" id="sent" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>To</th>
                                        <th>Message</th>
                                        <th>Date</th>
                                        <th>Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for message in sent_messages %}
                                    <tr>
                                        <td>
                                            {% if message.is_group_message %}
                                                <span class="badge bg-info">All Clients</span>
                                            {% else %}
                                                {% for recipient in message.recipients %}
                                                    <a href="{{ url_for('admin_view_client', client_id=recipient.id) }}">
                                                        {{ recipient.name }}
                                                    </a>
                                                {% endfor %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if message.audio_path %}
                                                <audio controls src="{{ url_for('uploaded_file', filename=message.audio_path) }}"></audio>
                                            {% elif message.content and message.content.startswith('[VOICE]:') %}
                                                {% set filename = message.content.split(':',1)[1] %}
                                                <audio controls src="{{ url_for('uploaded_file', filename=filename) }}"></audio>
                                            {% else %}
                                                {{ message.content|truncate(50) }}
                                            {% endif %}
                                        </td>
                                        <td>{{ message.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if message.is_group_message %}
                                                <span class="badge bg-primary">Group</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Individual</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center">No sent messages</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Compose Message Modal (still available if admin wants) -->
<div class="modal fade" id="composeMessageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Compose Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_messages') }}">
                {{ form.hidden_tag() }}
                <div class="modal-body">
                    <div class="mb-3 form-check">
                        {{ form.is_group(class="form-check-input") }}
                        {{ form.is_group.label(class="form-check-label") }}
                        <div class="form-text">Send this message to all clients.</div>
                    </div>
                    
                    <div class="mb-3" id="recipientField">
                        {{ form.recipient.label(class="form-label") }}
                        {{ form.recipient(class="form-select", id="recipientId") }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.content.label(class="form-label") }}
                        {{ form.content(class="form-control", rows=5) }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("voiceStatus");
    const playback = document.getElementById("lastPlayback");

    let mediaRecorder;
    let chunks = [];

    recordBtn.addEventListener("click", async function () {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];

            mediaRecorder.ondataavailable = e => chunks.push(e.data);

            mediaRecorder.onstart = () => {
                recordBtn.classList.add("d-none");
                stopBtn.classList.remove("d-none");
                status.textContent = "Recording...";
            };

            mediaRecorder.onstop = async () => {
                stopBtn.classList.add("d-none");
                recordBtn.classList.remove("d-none");
                status.textContent = "Uploading...";

                const blob = new Blob(chunks, { type: "audio/webm" });
                playback.src = URL.createObjectURL(blob);
                playback.style.display = "block";

                const fd = new FormData();
                fd.append("voice", blob, "voice_note.webm");

                try {
                    const res = await fetch("{{ url_for('upload_voice') }}", {
                        method: "POST",
                        body: fd
                    });
                    const data = await res.json();
                    if (res.ok) {
                        status.textContent = "Voice note sent!";
                        setTimeout(() => location.reload(), 800);
                    } else {
                        status.textContent = data.error || "Upload failed.";
                    }
                } catch (err) {
                    console.error("Upload error:", err);
                    status.textContent = "Error uploading voice note.";
                }
            };

            mediaRecorder.start();
        } catch (err) {
            alert("Microphone access denied.");
            console.error(err);
        }
    });

    stopBtn.addEventListener("click", function () {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
        }
    });
});
</script>
{% endblock %}
